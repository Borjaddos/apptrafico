<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predicciones en el Mapa</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .card {
            border: 1px solid #ccc;
            margin: 10px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>Predicciones en el Mapa</h1>
    
    <label for="fecha">Selecciona la Fecha:</label>
    <input type="date" id="fecha" value="{{ fecha_actual.strftime('%Y-%m-%d') }}">
    
    <label for="hora">Selecciona la Hora:</label>
    <input type="time" id="hora" value="00:00">
    
    <button id="cargarMapa">Cargar Mapa</button>
    
    <div id="map"></div>
    
    <h2>Próxima Predicción Mayor a 400:</h2>
    <div id="prediccion"></div>
    
    <script>
        $(document).ready(function() {
            $('#cargarMapa').click(function() {
                var fecha = $('#fecha').val();
                var hora = $('#hora').val();
                $.getJSON('/map_data/' + fecha + '/' + hora, function(data) {
                    // Inicializar el mapa
                    var map = L.map('map').setView([40.4168, -3.7038], 13); // Coordenadas de Madrid
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    }).addTo(map);

                    // Limpiar marcadores anteriores
                    for (var marker of window.markers || []) {
                        map.removeLayer(marker);
                    }
                    window.markers = [];

                    // Agregar nuevos marcadores
                    data.forEach(function(item) {
                        // Determinar color del marcador según ida y vuelta
                        var color = getMarkerColor(item.ida, item.vuelta);
                        var marker = L.circleMarker([item.Y, item.X], {
                            radius: 8,
                            fillColor: color,
                            color: color,
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map)
                        .bindPopup(`Descripción: ${item.description}<br>Ida: ${item.ida}<br>Vuelta: ${item.vuelta}`);
                        window.markers.push(marker);
                    });
                });

                // Cargar la próxima predicción
                $.getJSON('/next_prediction/400', function(data) {
                    if (data.error) {
                        $('#prediccion').html(data.error);
                    } else {
                        $('#prediccion').html(`
                            Estación: ${data.estacion}<br>
                            Fecha y Hora: ${data.fecha_hora}<br>
                            Ida: ${data.ida}<br>
                            Vuelta: ${data.vuelta}
                        `);
                    }
                });
            });

            function getMarkerColor(ida, vuelta) {
                if (ida > 450 || vuelta > 450) {
                    return 'red';
                } else if (ida > 300 || vuelta > 300) {
                    return 'orange';
                } else {
                    return 'green';
                }
            }
        });
    </script>
</body>
</html>
