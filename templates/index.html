<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Predicciones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh; /* Altura completa de la ventana */
            width: 100%; /* Ancho completo */
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <h1>Predicciones de Ida y Vuelta</h1>
        <input type="date" id="fecha" />
        <input type="time" id="hora" />
        <button id="cargarMapa">Cargar Mapa</button>
    </div>

    <div id="map"></div>

    <div id="predicciones"></div>

    <script>
        $(document).ready(function() {
            // Inicializar el mapa centrado en el País Vasco
            var map = L.map('map').setView([43.3, -2.0], 7); // Coordenadas aproximadas del País Vasco

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            $('#cargarMapa').click(function() {
                var fecha = $('#fecha').val();
                var hora = $('#hora').val();

                // Realizar la llamada AJAX para obtener los datos de la base de datos
                $.ajax({
                    url: '/map_data', // Cambia esto por la ruta que tienes en tu Flask para obtener datos
                    method: 'GET',
                    data: { fecha: fecha, hora: hora },
                    success: function(data) {
                        // Limpiar marcadores anteriores
                        map.eachLayer(function(layer) {
                            if (layer instanceof L.Marker) {
                                map.removeLayer(layer);
                            }
                        });

                        // Agregar nuevos marcadores
                        data.forEach(function(item) {
                            // Determinar el color del marcador
                            let color;
                            if (item.ida > 400 || item.vuelta > 400) {
                                color = 'red'; // Color para valores altos
                            } else if (item.ida > 200 || item.vuelta > 200) {
                                color = 'orange'; // Color para valores medianos
                            } else {
                                color = 'green'; // Color para valores bajos
                            }

                            // Crear un icono personalizado
                            var markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%;"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 20]
                            });

                            // Agregar el marcador al mapa
                            var marker = L.marker([item.Y, item.X], { icon: markerIcon }).addTo(map)
                                .bindPopup(`Descripción: ${item.Description}<br>Ida: ${item.ida}<br>Vuelta: ${item.vuelta}`);
                        });
                    },
                    error: function(err) {
                        console.error("Error al cargar los datos:", err);
                    }
                });
            });
        });
    </script>

</body>
</html>
